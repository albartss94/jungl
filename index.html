<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Jungl – Discover New Music</title>
<style>
/* (CSS unchanged – omitted here for brevity; keep the full sheet you already have) */
</style>
</head>
<body>

<div class="error-banner" id="err"></div>

<!-- (header, prompts, overlay, deck, buttons, stats markup unchanged) -->

<script>
/* ---------- CONFIG & HELPERS ---------- */
const CID='564aa538caf242638e9f895679012e50';
const RED='https://albartss94.github.io/jungl/';
const AUTH='https://accounts.spotify.com/authorize';
const TOKEN_URL='https://accounts.spotify.com/api/token';
const API='https://api.spotify.com/v1';
const SCOPES=['user-read-private','user-read-email','playlist-modify-public','playlist-modify-private'];

const rand=l=>[...crypto.getRandomValues(new Uint8Array(l))].map(x=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[x%62]).join('');
const sha=async s=>crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
const b64u=b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
const banner=document.getElementById('err');
const showErr=m=>{banner.textContent=m;banner.style.display='block';setTimeout(()=>banner.style.display='none',8000)};

/* ---------- STATE ---------- */
let token=null,seeds=[],chosen=[],queue=[],idx=0,liked=0,total=0,
    audio=null,playing=false,progInt=null;

/* ---------- DOM ---------- */
const overlay=document.getElementById('overlay');
const grid=document.getElementById('genreGrid');
const start=document.getElementById('startBtn');
const deck=document.getElementById('deck');
const actions=document.getElementById('actions');
const likedEl=document.getElementById('liked');
const totalEl=document.getElementById('total');

/* ---------- LOGIN FLOW ---------- */
async function login(){
  const ver=rand(64);sessionStorage.setItem('ver',ver);
  const chal=b64u(await sha(ver)),state=rand(16);sessionStorage.setItem('st',state);
  const qs=new URLSearchParams({
    response_type:'code',client_id:CID,redirect_uri:RED,
    code_challenge_method:'S256',code_challenge:chal,state,
    scope:SCOPES.join(' ')
  });
  location.href=`${AUTH}?${qs}`;
}
async function exchange(code){
  const body=new URLSearchParams({
    grant_type:'authorization_code',client_id:CID,code,
    redirect_uri:RED,code_verifier:sessionStorage.getItem('ver')
  });
  return fetch(TOKEN_URL,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body
  }).then(r=>r.json());
}

/* ---------- INIT ---------- */
window.addEventListener('load',async()=>{
  document.getElementById('headerLoginBtn').onclick=login;
  document.getElementById('mainLoginBtn').onclick=login;

  const p=new URLSearchParams(location.search);
  const code=p.get('code'),state=p.get('state');
  if(code){
    if(state!==sessionStorage.getItem('st'))return showErr('OAuth state mismatch');
    const data=await exchange(code);
    if(!data.access_token)return showErr('Token exchange failed');
    token=data.access_token;
    sessionStorage.setItem('tok',token);
    history.replaceState({},'',RED);
  }else{
    token=sessionStorage.getItem('tok');
  }

  if(token){
    document.getElementById('loginPrompt').style.display='none';
    document.getElementById('loginSection').style.display='none';
    document.getElementById('userInfo').style.display='flex';
    fetch(`${API}/me`,{headers:{Authorization:`Bearer ${token}`}})
      .then(r=>r.json())
      .then(u=>{document.getElementById('userName').textContent=u.display_name||'User';});
    await loadSeeds();
  }
});

/* ---------- GENRE SEEDS ---------- */
async function loadSeeds(){
  overlay.style.display='flex';
  grid.innerHTML='<div class="loading"><div class="loading-spinner"></div></div>';
  start.disabled=true;

  try{
    const r=await fetch(`${API}/recommendations/available-genre-seeds`,
      {headers:{Authorization:`Bearer ${token}`}});
    if(!r.ok){
      const e=await r.json();
      showErr(`Seed error ${r.status}: ${e.error?.message||e}`);
    }
    seeds=(await r.json()).genres||[];
  }catch{
    showErr('Network error while loading genre seeds');
    seeds=[];
  }

  if(!seeds.length){
    seeds=['pop','rock','hip-hop','edm','dance','house','indie','electronic','jazz','classical',
           'metal','folk','latin','soul','k-pop','reggae','country','ambient','blues','funk',
           'techno','trance'];
  }
  buildGrid();
}
function buildGrid(){
  grid.innerHTML='';
  chosen=[];
  start.disabled=true;
  [...seeds].slice(0,36).sort().forEach(g=>{
    const div=document.createElement('div');
    div.className='genre-item';
    div.textContent=g;
    div.onclick=()=>{
      div.classList.toggle('selected');
      chosen=[...document.querySelectorAll('.genre-item.selected')].map(e=>e.textContent);
      if(chosen.length>5){
        div.classList.remove('selected');
        chosen.pop();
      }
      start.disabled=chosen.length===0;
    };
    grid.appendChild(div);
  });
  start.onclick=startApp;
}

/* ---------- TRACKS ---------- */
async function startApp(){
  overlay.style.display='none';
  actions.style.display='none';
  deck.innerHTML='<div class="loading"><div class="loading-spinner"></div></div>';
  queue=[];
  idx=liked=total=0;
  updateStats();
  await fetchMore();
  renderDeck();
}
async function fetchMore(){
  try{
    const qs=new URLSearchParams({
      seed_genres:chosen.slice(0,5).join(','),
      limit:80,
      market:'from_token'
    });
    const r=await fetch(`${API}/recommendations?${qs}`,{
      headers:{Authorization:`Bearer ${token}`}}
    );
    if(!r.ok){
      const e=await r.json();
      return showErr(`Rec error ${r.status}: ${e.error?.message||e}`);
    }
    const j=await r.json();
    const more=j.tracks.filter(t=>t.preview_url);
    console.log(`Fetched ${more.length} playable / ${j.tracks.length} total`);
    queue.push(...more.sort(()=>Math.random()-.5));
  }catch{
    showErr('Network error while loading tracks');
  }
  if(!queue.length)queue.push(...demo);
}

/* ---------- DEMO ---------- */
const demo=[{id:'d1',name:'Electric Dreams',artists:[{name:'Neon Pulse'}],
  album:{images:[{url:'https://picsum.photos/400?random=1'}]},preview:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',pop:72},
{id:'d2',name:'Midnight City',artists:[{name:'Urban Echo'}],
  album:{images:[{url:'https://picsum.photos/400?random=2'}]},preview:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',pop:85}];

/* ---------- RENDER & INTERACTION ---------- */
function renderDeck(){
  deck.classList.add('active');
  deck.innerHTML='';
  actions.style.display='flex';
  for(let n=0;n<Math.min(2,queue.length-idx);n++)addCard(queue[idx+n],n);
}
function addCard(t,pos){
  const c=document.createElement('div');
  c.className='card';
  c.style.zIndex=10-pos;
  c.style.transform=`scale(${1-pos*.05}) translateY(${pos*10}px)`;
  c.innerHTML=`<div class="card-content">
    <div class="album-art">
      <img src="${t.album.images[0]?.url||''}" onerror="this.style.display='none'"/>
      <div class="audio-player">
        <button class="play-button"><span class="play-icon">▶</span></button>
        <div class="progress-bar"><div class="progress"></div></div><span class="time">0:00</span>
      </div>
    </div>
    <div class="song-info">
      <h2>${t.name}</h2><p class="artist">${t.artists[0].name}</p>
      <p class="genre">${chosen.join(', ')}</p>
      <div class="popularity">
        <span>Popularity</span><div class="popularity-bar"><div class="popularity-fill" style="width:${t.pop}%"></div></div>
        <span>${t.pop}%</span>
      </div>
    </div>
    <div class="love-indicator">LOVE</div><div class="nope-indicator">NOPE</div>
  </div>`;
  if(pos===0){setupSwipe(c,t);setupAudio(c,t);}
  deck.appendChild(c);
}

function setupAudio(card,t){
  const btn=card.querySelector('.play-button'),
        icon=btn.querySelector('.play-icon'),
        bar=card.querySelector('.progress'),
        tm=card.querySelector('.time');
  btn.onclick=()=>{
    if(audio&&playing){audio.pause();playing=false;icon.textContent='▶';return;}
    if(audio)audio.pause();
    audio=new Audio(t.preview);
    audio.volume=.7;
    audio.play().then(()=>{
      playing=true;icon.textContent='⏸';
      progInt=setInterval(()=>{
        if(!audio.duration)return;
        bar.style.width=(audio.currentTime/audio.duration*100)+'%';
        const s=Math.floor(audio.currentTime);
        tm.textContent=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
      },100);
    }).catch(console.log);
    audio.onended=()=>{playing=false;icon.textContent='▶';clearInterval(progInt);};
  };
}

function setupSwipe(card,t){
  let sx=0,dx=0,drag=false;
  const love=card.querySelector('.love-indicator'),
        nope=card.querySelector('.nope-indicator');
  const start=e=>{drag=true;sx=(e.touches?e.touches[0].clientX:e.clientX);card.classList.add('dragging');};
  const move=e=>{
    if(!drag)return;
    dx=(e.touches?e.touches[0].clientX:e.clientX)-sx;
    card.style.transform=`translateX(${dx}px) rotate(${dx/10}deg)`;
    const o=Math.min(Math.abs(dx)/120,1);
    love.style.opacity=dx>0?o:0;
    nope.style.opacity=dx<0?o:0;
  };
  const end=()=>{
    if(!drag)return;drag=false;card.classList.remove('dragging');
    if(Math.abs(dx)>110){swipe(dx>0);}else{
      card.style.transform='';love.style.opacity=0;nope.style.opacity=0;
    }
  };
  ['mousedown','touchstart'].forEach(ev=>card.addEventListener(ev,start));
  ['mousemove','touchmove'].forEach(ev=>card.addEventListener(ev,move));
  ['mouseup','mouseleave','touchend'].forEach(ev=>card.addEventListener(ev,end));
  document.getElementById('like').onclick=()=>swipe(true);
  document.getElementById('dislike').onclick=()=>swipe(false);
  function swipe(like){
    card.classList.add(like?'swiped-right':'swiped-left');
    total++;if(like)liked++;updateStats();
    idx++;
    if(queue.length-idx<15)fetchMore(); // keep buffer filled
    setTimeout(()=>{
      const next=queue[idx];
      if(next)addCard(next,0);
      card.remove();
    },220);
  }
}

function updateStats(){
  likedEl.textContent=liked;
  totalEl.textContent=total;
}
</script>
</body>
</html>
