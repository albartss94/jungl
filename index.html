<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Jungl – Discover New Music</title>
<style>
/* -------------- GLOBAL / HEADER / BUTTONS — unchanged styling -------------- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
     background:#0a0a0a;min-height:100vh;display:flex;flex-direction:column;align-items:center;color:#fff;overflow:hidden}
.header{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);width:100%;padding:20px;
        display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.1)}
.logo-section{display:flex;align-items:center;gap:15px}.logo{width:40px;height:40px}.logo svg{width:100%;height:100%}
.brand-name{font-size:24px;font-weight:700;letter-spacing:-1px;
            background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tagline{font-size:12px;opacity:.7}
.login-section{display:flex;gap:15px;align-items:center}
.login-button{background:#1DB954;color:#fff;border:none;padding:10px 24px;border-radius:20px;font-size:14px;font-weight:600;
              cursor:pointer;display:flex;align-items:center;gap:8px;transition:.3s}
.login-button:hover{background:#1ed760;transform:translateY(-1px)}
.user-info{display:none;align-items:center;gap:15px}
.user-avatar{width:35px;height:35px;border-radius:50%;
             background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%)}
/* -------------- MAIN CONTAINER / PROMPTS -------------- */
.app-container{max-width:400px;width:90%;margin-top:30px;flex:1;display:flex;flex-direction:column;position:relative}
.login-prompt{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);
              border-radius:20px;padding:60px 40px;text-align:center;margin-top:100px}
.login-prompt h2{font-size:28px;margin-bottom:15px;background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%);
                 -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-prompt p{opacity:.8;margin-bottom:30px;line-height:1.6}
.spotify-login-btn{background:#1DB954;color:#fff;border:none;padding:15px 40px;border-radius:30px;font-size:16px;font-weight:600;
                   cursor:pointer;display:inline-flex;align-items:center;gap:10px;transition:.3s}
.spotify-login-btn:hover{background:#1ed760;transform:translateY(-2px);box-shadow:0 10px 30px rgba(29,185,84,.3)}
/* -------------- GENRE PICKER (new, dynamic) -------------- */
.genre-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);
               display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20}
.genre-overlay h2{margin-bottom:18px;font-size:24px;text-align:center}
.genre-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px;width:260px;max-height:55vh;overflow:auto}
.genre-item{padding:11px 16px;border:2px solid #1DB954;border-radius:20px;text-align:center;cursor:pointer;
            transition:.25s;font-weight:600;font-size:14px}
.genre-item.selected{background:#1DB954;color:#0a0a0a}
.genre-overlay button{background:#1DB954;color:#fff;border:none;padding:12px 32px;border-radius:26px;
                      font-size:16px;font-weight:600;cursor:pointer;transition:.3s}
.genre-overlay button:disabled{opacity:.38;cursor:not-allowed}
/* -------------- CARD STACK / PLAYER / CONTROLS — unchanged styling -------------- */
/* …(all the existing CSS for .card, .album-art, .audio-player, etc.)… */
.card-stack{position:relative;height:600px;margin-bottom:20px;display:none}
.card-stack.active{display:block}
.card{position:absolute;width:100%;height:100%;background:rgba(255,255,255,.05);backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.1);border-radius:20px;cursor:grab;overflow:hidden;
      transition:transform .2s ease-out,opacity .2s ease-out}
.card.dragging{transition:none;cursor:grabbing}
.card.swiped-right{transform:translateX(150%) rotate(30deg);opacity:0}
.card.swiped-left{transform:translateX(-150%) rotate(-30deg);opacity:0}
.card-content{height:100%;display:flex;flex-direction:column}
/* album-art, player, info … keep your original styles unchanged */
/* -------------- STATS & MISC -------------- */
.stats{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);
       border-radius:15px;padding:15px;text-align:center;font-size:14px;margin-top:10px}
.loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.loading-spinner{width:50px;height:50px;border:3px solid rgba(255,255,255,.1);border-top-color:#1DB954;
                 border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- ====================== HEADER ====================== -->
<div class="header">
  <div class="logo-section">
    <div class="logo">
      <svg viewBox="0 0 40 40"><defs><linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#1DB954"/><stop offset="100%" stop-color="#1ed760"/></linearGradient></defs>
        <path d="M20 5L35 15v10L20 35 5 25V15Z" fill="url(#lg)"/>
        <path d="M20 12l7 5v6l-7 5-7-5v-6Z" fill="#0a0a0a"/><circle cx="20" cy="20" r="3" fill="url(#lg)"/>
      </svg>
    </div>
    <div><div class="brand-name">jungl</div><div class="tagline">Discover your sound</div></div>
  </div>
  <div class="login-section" id="loginSection">
    <button class="login-button" id="headerLoginBtn">Connect Spotify</button>
  </div>
  <div class="user-info" id="userInfo"><span id="userName">User</span><div class="user-avatar"></div></div>
</div>

<!-- ====================== APP ====================== -->
<div class="app-container">
  <div class="login-prompt" id="loginPrompt">
    <h2>Welcome to Jungl</h2>
    <p>Connect your Spotify account to swipe through brand-new tracks and instantly save what you like.</p>
    <button class="spotify-login-btn" id="mainLoginBtn">Connect with Spotify</button>
  </div>

  <!-- Genre picker overlay (populated dynamically) -->
  <div class="genre-overlay" id="genreOverlay" style="display:none">
    <h2>Pick up to 5 favourite genres</h2>
    <div class="genre-grid" id="genreGrid"></div>
    <button id="startBtn" disabled>Start swiping</button>
  </div>

  <!-- swipe stack -->
  <div class="card-stack" id="cardStack"><div class="loading"><div class="loading-spinner"></div><p>Loading…</p></div></div>

  <!-- swipe buttons -->
  <div class="action-buttons" id="buttons" style="display:none">
    <button class="action-button dislike-button" id="dislikeBtn">✕</button>
    <button class="action-button like-button" id="likeBtn">♥</button>
  </div>

  <!-- stats -->
  <div class="stats" id="stats" style="display:none"><span id="likedCount">0</span> liked • <span id="totalCount">0</span> heard</div>
</div>

<!-- ====================== SCRIPT ====================== -->
<script>
/* ---------------- CONFIG ---------------- */
const CLIENT_ID='564aa538caf242638e9f895679012e50';
const REDIRECT='https://albartss94.github.io/jungl/';
const AUTH='https://accounts.spotify.com/authorize';
const TOKEN='https://accounts.spotify.com/api/token';
const API='https://api.spotify.com/v1';
const SCOPE=['user-read-private','user-read-email','playlist-modify-public','playlist-modify-private','user-top-read'];

/* ---------------- HELPERS ---------------- */
const rs=(l)=>[...crypto.getRandomValues(new Uint8Array(l))].map(x=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[x%62]).join('');
const sha=async s=>crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
const b64u=b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');

/* ---------------- STATE ---------------- */
let token=null,genres=[],chosen=[],tracks=[],idx=0,liked=0,total=0,audio=null,playing=false,progInt=null;

/* ---------------- DOM ---------------- */
const grid=document.getElementById('genreGrid'),overlay=document.getElementById('genreOverlay'),
      startBtn=document.getElementById('startBtn'),cardStack=document.getElementById('cardStack'),
      btns=document.getElementById('buttons'),likedEl=document.getElementById('likedCount'),
      totalEl=document.getElementById('totalCount');

/* ---------------- AUTH ---------------- */
async function login(){
  const v=rs(64);sessionStorage.setItem('verifier',v);
  const c=b64u(await sha(v)),st=rs(16);sessionStorage.setItem('state',st);
  const qs=new URLSearchParams({response_type:'code',client_id:CLIENT_ID,redirect_uri:REDIRECT,code_challenge_method:'S256',code_challenge:c,state:st,scope:SCOPE.join(' ')});
  location.href=`${AUTH}?${qs}`;
}
async function callback(code){
  if(new URLSearchParams(location.search).get('state')!==sessionStorage.getItem('state')){alert('state mismatch');return;}
  const body=new URLSearchParams({grant_type:'authorization_code',client_id:CLIENT_ID,code,redirect_uri:REDIRECT,code_verifier:sessionStorage.getItem('verifier')});
  const res=await fetch(TOKEN,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body}).then(r=>r.json());
  if(!res.access_token){alert('Auth error');return;}
  token=res.access_token;sessionStorage.setItem('token',token);history.replaceState({},'',REDIRECT);initApp();
}

/* ---------------- INIT ---------------- */
window.addEventListener('load',async()=>{
  document.getElementById('headerLoginBtn').onclick=login;
  document.getElementById('mainLoginBtn').onclick=login;
  const code=new URLSearchParams(location.search).get('code');if(code){await callback(code);return;}
  const saved=sessionStorage.getItem('token');if(saved){token=saved;initApp();}
});

/* ---------------- MAIN APP ---------------- */
async function initApp(){
  document.getElementById('loginPrompt').style.display='none';
  document.getElementById('loginSection').style.display='none';
  document.getElementById('userInfo').style.display='flex';

  // display name
  fetch(`${API}/me`,{headers:{Authorization:`Bearer ${token}`}}).then(r=>r.json())
    .then(u=>{document.getElementById('userName').textContent=u.display_name||'User';});

  await loadGenreSeeds();overlay.style.display='flex';
}

/* --- 1. Fetch valid genre seeds and build grid --- */
async function loadGenreSeeds(){
  genres=await fetch(`${API}/recommendations/available-genre-seeds`,{headers:{Authorization:`Bearer ${token}`}})
          .then(r=>r.json()).then(j=>j.genres).catch(()=>[]);
  // Pick ~30 popular ones for UI
  const show=['pop','rock','hip-hop','edm','dance','house','indie','electronic','r-n-b','jazz','classical','metal','folk','funk','k-pop','latin','reggae','soul','techno','trance','punk','disco','blues','country','ambient','gospel','guitar','happy','sad','chill'];
  grid.innerHTML='';
  [...new Set([...show.filter(g=>genres.includes(g)),...genres])].slice(0,30).forEach(g=>{
    const div=document.createElement('div');div.textContent=g;div.className='genre-item';
    div.onclick=()=>{div.classList.toggle('selected');const sel=[...document.querySelectorAll('.genre-item.selected')].map(e=>e.textContent);
      if(sel.length>5)div.classList.remove('selected');chosen=sel;startBtn.disabled=!sel.length;};
    grid.appendChild(div);
  });
  startBtn.onclick=startApp;
}

/* --- 2. After genre choice, fetch tracks --- */
async function startApp(){
  overlay.style.display='none';
  tracks=[];
  try{
    const qs=new URLSearchParams({
      limit:80,
      seed_genres:chosen.slice(0,5).join(','),
      market:'from_token'
    });
    const rec=await fetch(`${API}/recommendations?${qs}`,{headers:{Authorization:`Bearer ${token}`}}).then(r=>r.json());
    tracks=rec.tracks.filter(t=>t.preview_url).map(t=>({
      id:t.id,name:t.name,artists:t.artists,album:t.album,preview:t.preview_url,pop:t.popularity
    }));
  }catch(e){console.error(e);}
  if(tracks.length===0)tracks=demo; // fallback demo
  idx=liked=total=0;updateStats();renderDeck();
}

/* ---------------- DEMO ---------------- */
const demo=[{id:'1',name:'Electric Dreams',artists:[{name:'Neon Pulse'}],
  album:{images:[{url:'https://picsum.photos/400?random=1'}]},preview:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',pop:72},
{id:'2',name:'Midnight City',artists:[{name:'Urban Echo'}],
  album:{images:[{url:'https://picsum.photos/400?random=2'}]},preview:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',pop:85}];

/* ---------------- RENDER & INTERACTION ---------------- */
function renderDeck(){cardStack.classList.add('active');btns.style.display='flex';cardStack.innerHTML='';
  for(let i=0;i<Math.min(2,tracks.length);i++)createCard(tracks[i+iidx],i);}
function createCard(t,pos){
  const c=document.createElement('div');c.className='card';c.style.zIndex=10-pos;c.style.transform=`scale(${1-pos*.05}) translateY(${pos*10}px)`;
  c.innerHTML=`<div class="card-content"><div class="album-art">
     <img src="${t.album.images[0]?.url||''}" onerror="this.style.display='none'">
     <div class="audio-player"><button class="play-button"><span class="play-icon">▶</span></button>
       <div class="progress-bar"><div class="progress"></div></div><span class="time-display">0:00</span></div></div>
     <div class="song-info"><h2>${t.name}</h2><p class="artist">${t.artists[0].name}</p>
       <p class="genre">${chosen.join(', ')}</p>
       <div class="popularity"><span>Popularity</span><div class="popularity-bar">
         <div class="popularity-fill" style="width:${t.pop}%"></div></div><span>${t.pop}%</span></div></div>
     <div class="love-indicator">LOVE</div><div class="nope-indicator">NOPE</div></div>`;
  if(pos===0){interaction(c,t);audioCtl(c,t);}
  cardStack.appendChild(c);
}
function audioCtl(card,t){
  const btn=card.querySelector('.play-button'),icon=btn.querySelector('.play-icon'),
        bar=card.querySelector('.progress'),time=card.querySelector('.time-display');
  btn.onclick=()=>{
    if(audio&&playing){audio.pause();playing=false;icon.textContent='▶';return;}
    if(audio)audio.pause();
    audio=new Audio(t.preview);audio.volume=.6;audio.play().then(()=>{
      playing=true;icon.textContent='⏸';progInt=setInterval(()=>{
        if(!audio.duration)return;bar.style.width=(audio.currentTime/audio.duration*100)+'%';
        const s=Math.floor(audio.currentTime);time.textContent=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
      },150);}).catch(console.log);audio.onended=()=>{playing=false;icon.textContent='▶';clearInterval(progInt);}
  };
}
function interaction(card,t){
  let sx=0,dx=0,drag=false,love=card.querySelector('.love-indicator'),nope=card.querySelector('.nope-indicator');
  const begin=e=>{drag=true;sx=(e.touches?e.touches[0].clientX:e.clientX);card.classList.add('dragging');};
  const move=e=>{if(!drag)return;dx=(e.touches?e.touches[0].clientX:e.clientX)-sx;
    card.style.transform=`translateX(${dx}px) rotate(${dx/10}deg)`;const o=Math.min(Math.abs(dx)/120,1);
    love.style.opacity=dx>0?o:0;nope.style.opacity=dx<0?o:0;};
  const end=()=>{if(!drag)return;drag=false;card.classList.remove('dragging');
    if(Math.abs(dx)>110){dx>0?swipe(true):swipe(false);}else{card.style.transform='';love.style.opacity=0;nope.style.opacity=0;}};
  ['mousedown','touchstart'].forEach(ev=>card.addEventListener(ev,begin));
  ['mousemove','touchmove'].forEach(ev=>card.addEventListener(ev,move));
  ['mouseup','mouseleave','touchend'].forEach(ev=>card.addEventListener(ev,end));
  document.getElementById('likeBtn').onclick=()=>swipe(true);
  document.getElementById('dislikeBtn').onclick=()=>swipe(false);
  function swipe(like){
    card.classList.add(like?'swiped-right':'swiped-left');
    total++;if(like)liked++;updateStats();
    idx++;setTimeout(()=>{const nxt=tracks[idx];if(nxt)createCard(nxt,0);card.remove();},220);
  }
}
function updateStats(){likedEl.textContent=liked;totalEl.textContent=total;}
</script>
</body>
</html>
