<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Jungl – Discover New Music</title>

<!-- =================  FULL CSS  ================= -->
<style>
/* ---------- GLOBAL ---------- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
     background:#0a0a0a;min-height:100vh;color:#fff;display:flex;flex-direction:column;align-items:center;overflow:hidden}

/* ---------- ERROR BANNER ---------- */
.error-banner{position:fixed;top:0;left:0;right:0;background:#ff4458;color:#fff;padding:10px 15px;
              font-size:14px;text-align:center;z-index:999;display:none}

/* ---------- HEADER ---------- */
.header{width:100%;padding:20px;display:flex;justify-content:space-between;align-items:center;
        background:rgba(255,255,255,.05);backdrop-filter:blur(20px);
        border-bottom:1px solid rgba(255,255,255,.1)}
.logo-section{display:flex;align-items:center;gap:15px}
.logo{width:40px;height:40px}.logo svg{width:100%;height:100%}
.brand-name{font-size:24px;font-weight:700;letter-spacing:-1px;
            background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tagline{font-size:12px;opacity:.7}
.login-section{display:flex;align-items:center;gap:15px}
.login-button{background:#1DB954;border:none;color:#fff;padding:10px 24px;border-radius:20px;font-size:14px;font-weight:600;
              cursor:pointer;display:flex;align-items:center;gap:8px;transition:.3s}
.login-button:hover{background:#1ed760;transform:translateY(-1px)}
.user-info{display:none;align-items:center;gap:15px}
.user-avatar{width:35px;height:35px;border-radius:50%;background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%)}

/* ---------- PROMPT ---------- */
.app-container{max-width:400px;width:90%;margin-top:30px;flex:1;display:flex;flex-direction:column;position:relative}
.login-prompt{margin-top:100px;padding:60px 40px;border-radius:20px;text-align:center;
              background:rgba(255,255,255,.05);backdrop-filter:blur(20px);
              border:1px solid rgba(255,255,255,.1)}
.login-prompt h2{font-size:28px;margin-bottom:15px;
                 background:linear-gradient(135deg,#1DB954 0%,#1ed760 100%);
                 -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-prompt p{opacity:.8;margin-bottom:30px;line-height:1.6}
.spotify-login-btn{background:#1DB954;border:none;color:#fff;padding:15px 40px;border-radius:30px;
                   font-size:16px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:10px;transition:.3s}
.spotify-login-btn:hover{background:#1ed760;transform:translateY(-2px);box-shadow:0 10px 30px rgba(29,185,84,.3)}

/* ---------- GENRE OVERLAY ---------- */
.genre-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);
               display:none;flex-direction:column;align-items:center;justify-content:center;z-index:20}
.genre-overlay h2{margin-bottom:18px;font-size:24px;text-align:center}
.genre-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px;width:260px;
            max-height:58vh;overflow:auto;padding-right:6px}
.genre-item{padding:11px 16px;border:2px solid #1DB954;border-radius:20px;text-align:center;
            cursor:pointer;transition:.25s;font-weight:600;font-size:14px}
.genre-item.selected{background:#1DB954;color:#0a0a0a}
.genre-overlay button{background:#1DB954;color:#fff;border:none;padding:12px 32px;border-radius:26px;
                      font-size:16px;font-weight:600;cursor:pointer;transition:.3s}
.genre-overlay button:disabled{opacity:.38;cursor:not-allowed}

/* ---------- CARD STACK ---------- */
.card-stack{position:relative;height:600px;margin-bottom:20px;display:none}
.card-stack.active{display:block}
.card{position:absolute;width:100%;height:100%;border-radius:20px;
      background:rgba(255,255,255,.05);backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.1);cursor:grab;overflow:hidden;
      transition:transform .2s ease-out,opacity .2s ease-out}
.card.dragging{transition:none;cursor:grabbing}
.card.swiped-right{transform:translateX(150%) rotate(30deg);opacity:0}
.card.swiped-left{transform:translateX(-150%) rotate(-30deg);opacity:0}
.card-content{height:100%;display:flex;flex-direction:column}

/* album art */
.album-art{width:100%;height:60%;background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 100%);
           display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.album-art img{width:100%;height:100%;object-fit:cover}

/* mini player */
.audio-player{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
              display:flex;align-items:center;gap:15px;padding:15px 30px;border-radius:30px;
              background:rgba(0,0,0,.85);backdrop-filter:blur(18px);
              border:1px solid rgba(255,255,255,.1)}
.play-button{width:40px;height:40px;border:none;border-radius:50%;background:#1DB954;color:#fff;
             cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s}
.play-button:hover{background:#1ed760;transform:scale(1.1)}
.play-button:active{transform:scale(.95)}
.progress-bar{width:150px;height:4px;border-radius:2px;background:rgba(255,255,255,.2);overflow:hidden}
.progress{height:100%;width:0%;background:#1DB954}.time{font-size:12px;font-weight:500}

/* song info */
.song-info{padding:30px;flex:1;display:flex;flex-direction:column;justify-content:center}
.song-info h2{font-size:24px;margin-bottom:10px}
.song-info .artist{font-size:18px;color:#aaa;margin-bottom:5px}
.song-info .genre{font-size:14px;color:#666;margin-bottom:20px}
.song-info .popularity{display:flex;align-items:center;gap:10px;font-size:14px;color:#aaa}
.popularity-bar{width:100px;height:6px;border-radius:3px;background:rgba(255,255,255,.1);overflow:hidden}
.popularity-fill{height:100%;background:linear-gradient(90deg,#1DB954,#1ed760);width:0%;transition:width 1s ease-out}

/* swipe indicators */
.love-indicator,.nope-indicator{position:absolute;top:50%;transform:translateY(-50%) rotate(-30deg);
                                font-size:60px;font-weight:bold;padding:10px 30px;border-radius:10px;border:4px solid;
                                opacity:0;transition:.2s}
.love-indicator{right:20px;color:#1DB954;border-color:#1DB954}
.nope-indicator{left:20px;color:#ff4458;border-color:#ff4458}

/* buttons & stats */
.action-buttons{display:flex;justify-content:center;gap:40px;margin-bottom:20px}
.action-button{width:60px;height:60px;border-radius:50%;border:2px solid;font-size:24px;cursor:pointer;
               background:rgba(255,255,255,.05);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;
               transition:.3s;position:relative}
.action-button:hover{transform:scale(1.1)}
.action-button:active{transform:scale(.95)}
.dislike-button{border-color:#ff4458;color:#ff4458}.dislike-button:hover{background:#ff4458;color:#fff}
.like-button{border-color:#1DB954;color:#1DB954}.like-button:hover{background:#1DB954;color:#fff}
.button-label{position:absolute;bottom:-25px;font-size:12px;opacity:0.7;white-space:nowrap}
.stats{margin-top:30px;padding:15px;border-radius:15px;text-align:center;font-size:14px;
       background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1)}

/* playlist button */
.playlist-button{margin-top:15px;background:#1DB954;border:none;color:#fff;padding:12px 24px;
                 border-radius:20px;font-size:14px;font-weight:600;cursor:pointer;display:none;
                 transition:.3s;margin:15px auto 0}
.playlist-button:hover{background:#1ed760;transform:translateY(-1px)}

/* back button */
.back-button{margin-top:15px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
             color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:600;
             cursor:pointer;transition:.3s}
.back-button:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}

/* loading spinner */
.loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.loading-spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,.1);border-top-color:#1DB954;
                 border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* responsive */
@media (max-width: 480px) {
  .card-stack{height:500px}
  .song-info{padding:20px}
  .song-info h2{font-size:20px}
  .action-buttons{gap:30px}
}
</style>
</head>
<body>

<!-- error banner -->
<div class="error-banner" id="err"></div>

<!-- ================= HEADER ================= -->
<div class="header">
  <div class="logo-section">
    <div class="logo">
      <svg viewBox="0 0 40 40">
        <defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#1DB954"/><stop offset="100%" stop-color="#1ed760"/></linearGradient></defs>
        <path d="M20 5L35 15v10L20 35 5 25V15Z" fill="url(#grad)"/>
        <path d="M20 12l7 5v6l-7 5-7-5v-6Z" fill="#0a0a0a"/><circle cx="20" cy="20" r="3" fill="url(#grad)"/>
      </svg>
    </div>
    <div><div class="brand-name">jungl</div><div class="tagline">Discover your sound</div></div>
  </div>
  <div class="login-section" id="loginSection">
    <button class="login-button" id="headerLoginBtn">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 0C4.5 0 0 4.5 0 10s4.5 10 10 10 10-4.5 10-10S15.5 0 10 0zm4.6 14.5c-.2.3-.5.4-.8.2-2.2-1.3-5-1.6-8.3-.9-.3.1-.6-.1-.7-.4-.1-.3.1-.6.4-.7 3.6-.8 6.7-.5 9.2 1 .3.2.4.5.2.8zm1.1-2.5c-.2.4-.6.5-1 .3-2.5-1.5-6.3-2-9.3-1.1-.4.1-.8-.1-.9-.5-.1-.4.1-.8.5-.9 3.4-1 7.6-.5 10.5 1.3.4.1.5.5.2.9zm.1-2.6c-3-1.8-8-2-10.9-1.1-.5.2-.9-.1-1.1-.5-.2-.5.1-.9.5-1.1 3.3-1 8.8-.8 12.3 1.3.4.2.6.7.3 1.1-.2.4-.7.5-1.1.3z"/>
      </svg>
      Connect Spotify
    </button>
  </div>
  <div class="user-info" id="userInfo"><span id="userName">User</span><div class="user-avatar"></div></div>
</div>

<!-- ================= APP ================= -->
<div class="app-container">
  <!-- login prompt -->
  <div class="login-prompt" id="loginPrompt">
    <h2>Welcome to Jungl</h2>
    <p>Connect your Spotify account to swipe through track previews and build your discovery playlist.</p>
    <button class="spotify-login-btn" id="mainLoginBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm5.5 17.4c-.2.4-.6.5-1 .3-2.6-1.6-6-2-8.9-1.1-.4.1-.8-.1-.9-.5-.1-.4.1-.8.5-.9 3.2-.9 8.1-.5 11.1 1.3.4.1.5.5.2.9zm1.3-3c-.3.4-.8.6-1.2.4-3-1.9-7.6-2.4-11.2-1.3-.5.1-1-.1-1.1-.6-.1-.5.1-1 .6-1.1 4.1-1.2 9.1-.6 12.6 1.5.4.2.6.7.3 1.1zm.1-3.1c-3.6-2.1-9.6-2.3-13.1-1.3-.6.2-1.2-.2-1.3-.7-.2-.6.2-1.2.7-1.3 4-1.2 10.6-.9 14.8 1.5.5.3.7.9.4 1.4-.3.5-.9.7-1.5.4z"/>
      </svg>
      Connect with Spotify
    </button>
  </div>

  <!-- genre overlay -->
  <div class="genre-overlay" id="overlay">
    <h2>Pick up to 5 favourite genres</h2>
    <div class="genre-grid" id="genreGrid">
      <div class="loading"><div class="loading-spinner"></div></div>
    </div>
    <button id="startBtn" disabled>Start swiping</button>
  </div>

  <!-- card stack -->
  <div class="card-stack" id="deck">
    <div class="loading"><div class="loading-spinner"></div><p>Loading…</p></div>
  </div>

  <!-- buttons -->
  <div class="action-buttons" id="actions" style="display:none">
    <button class="action-button dislike-button" id="dislike">
      ✕
      <span class="button-label">Not for me</span>
    </button>
    <button class="action-button like-button" id="like">
      ♥
      <span class="button-label">Love it!</span>
    </button>
  </div>

  <!-- stats -->
  <div class="stats" id="stats" style="display:none">
    <span id="liked">0</span> liked • <span id="total">0</span> heard
    <button class="playlist-button" id="createPlaylist">Create Playlist</button>
    <button class="back-button" id="backToGenres" style="display:none">Change Genres</button>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- CONFIG & HELPERS ---------- */
const CID='564aa538caf242638e9f895679012e50';
const RED='https://albartss94.github.io/jungl/';
const AUTH='https://accounts.spotify.com/authorize';
const TOKEN_URL='https://accounts.spotify.com/api/token';
const API='https://api.spotify.com/v1';
const SCOPES=['user-read-private','user-read-email','playlist-modify-public','playlist-modify-private','user-top-read'];

const rand=l=>[...crypto.getRandomValues(new Uint8Array(l))].map(x=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[x%62]).join('');
const sha=async s=>crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
const b64u=b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
const showErr=m=>{const b=document.getElementById('err');b.textContent=m;b.style.display='block';setTimeout(()=>b.style.display='none',8000)};

/* ---------- STATE ---------- */
let token=null,seeds=[],chosen=[],queue=[],idx=0,liked=0,total=0,audio=null,playing=false,prog=null;
let likedTracks=[], userId=null, userPrefs={genres:{},artists:{},features:{}}, autoplayEnabled=false;

/* ---------- DOM refs ---------- */
const overlay=document.getElementById('overlay'),grid=document.getElementById('genreGrid'),
      start=document.getElementById('startBtn'),deck=document.getElementById('deck'),
      actions=document.getElementById('actions'),likedEl=document.getElementById('liked'),
      totalEl=document.getElementById('total'),statsEl=document.getElementById('stats'),
      playlistBtn=document.getElementById('createPlaylist'),
      backBtn=document.getElementById('backToGenres');

/* ---------- LOGIN ---------- */
async function login(){
  const ver=rand(64);sessionStorage.setItem('ver',ver);
  const chal=b64u(await sha(ver)),state=rand(16);sessionStorage.setItem('st',state);
  const qs=new URLSearchParams({response_type:'code',client_id:CID,redirect_uri:RED,
    code_challenge_method:'S256',code_challenge:chal,state,scope:SCOPES.join(' ')});
  location.href=`${AUTH}?${qs}`;
}
async function exchange(code){
  const body=new URLSearchParams({grant_type:'authorization_code',client_id:CID,code,
                                  redirect_uri:RED,code_verifier:sessionStorage.getItem('ver')});
  try {
    const resp = await fetch(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
    if (!resp.ok) {
      const errorText = await resp.text();
      console.error('Token exchange failed:', errorText);
      throw new Error('Token exchange failed');
    }
    return await resp.json();
  } catch (e) {
    console.error('Exchange error:', e);
    throw e;
  }
}

/* ---------- INIT ---------- */
window.addEventListener('load',async()=>{
  document.getElementById('headerLoginBtn').onclick=login;
  document.getElementById('mainLoginBtn').onclick=login;
  playlistBtn.onclick=createPlaylist;
  backBtn.onclick=backToGenres;

  const p=new URLSearchParams(location.search),code=p.get('code'),state=p.get('state'),error=p.get('error');
  
  if(error) {
    showErr(`Spotify authorization error: ${error}`);
    return;
  }
  
  if(code){
    if(state!==sessionStorage.getItem('st')){
      showErr('OAuth state mismatch');
      return;
    }
    try {
      const data=await exchange(code);
      if(!data.access_token){
        showErr('Token exchange failed - no access token received');
        return;
      }
      token=data.access_token;
      sessionStorage.setItem('tok',token);
      history.replaceState({},'',RED);
    } catch(e) {
      showErr('Failed to exchange authorization code');
      return;
    }
  } else {
    token=sessionStorage.getItem('tok');
  }

  if(token){
    document.getElementById('loginPrompt').style.display='none';
    document.getElementById('loginSection').style.display='none';
    document.getElementById('userInfo').style.display='flex';
    
    try {
      const resp = await fetch(`${API}/me`,{headers:{Authorization:`Bearer ${token}`}});
      if(resp.ok) {
        const u = await resp.json();
        userId = u.id;
        document.getElementById('userName').textContent=u.display_name||'User';
        await loadSeeds();
      } else if(resp.status === 401) {
        sessionStorage.removeItem('tok');
        showErr('Session expired. Please login again.');
        setTimeout(() => location.reload(), 2000);
      }
    } catch(e) {
      showErr('Failed to load user profile');
    }
  }
});

/* ---------- BACK TO GENRES ---------- */
function backToGenres(){
  deck.classList.remove('active');
  actions.style.display='none';
  statsEl.style.display='none';
  overlay.style.display='flex';
  if(audio){
    audio.pause();
    playing=false;
  }
}

/* ---------- GENRE SEEDS ---------- */
async function loadSeeds(){
  overlay.style.display='flex';
  grid.innerHTML='<div class="loading"><div class="loading-spinner"></div></div>';
  start.disabled=true;
  
  try{
    // Try to get user's top artists for preferences (might fail for dev apps)
    try {
      const topResp = await fetch(`${API}/me/top/artists?limit=10`, 
        {headers:{Authorization:`Bearer ${token}`}});
      if(topResp.ok) {
        const topData = await topResp.json();
        if(topData.items) {
          topData.items.forEach(artist => {
            if(artist.genres) {
              artist.genres.forEach(g => {
                userPrefs.genres[g] = (userPrefs.genres[g] || 0) + 1;
              });
            }
          });
        }
      }
    } catch(e) {
      console.log('Could not load top artists - using default genres');
    }
    
    // Since genre seeds endpoint might be restricted, just use our fallback list
    seeds = getFallbackGenres();
    console.log('Using fallback genre list');
    
  }catch(e){
    console.error('Error in loadSeeds:', e);
    seeds=getFallbackGenres();
  }
  
  buildGrid();
}

function getFallbackGenres() {
  return ['pop','rock','hip-hop','edm','dance','house','indie','electronic','jazz','classical',
          'metal','folk','latin','soul','k-pop','reggae','country','ambient','blues','funk',
          'techno','trance','r-n-b','alternative','punk','disco','synthpop','trap','dubstep',
          'reggaeton','afrobeat','gospel','world-music','new-age','opera'];
}

function buildGrid(){
  grid.innerHTML='';
  chosen=[];
  
  const sortedSeeds = [...seeds].sort((a,b) => {
    const aScore = userPrefs.genres[a] || 0;
    const bScore = userPrefs.genres[b] || 0;
    return bScore - aScore;
  });
  
  sortedSeeds.slice(0,36).forEach(g=>{
    const div=document.createElement('div');
    div.className='genre-item';
    div.textContent=g;
    div.onclick=()=>{
      div.classList.toggle('selected');
      chosen=[...document.querySelectorAll('.genre-item.selected')].map(e=>e.textContent);
      if(chosen.length>5){
        div.classList.remove('selected');
        chosen.pop();
        showErr('Maximum 5 genres allowed');
      }
      start.disabled=chosen.length===0;
    };
    grid.appendChild(div);
  });
  start.onclick=startApp;
}

/* ---------- TRACKS ---------- */
async function startApp(){
  overlay.style.display='none';
  actions.style.display='flex';
  statsEl.style.display='block';
  backBtn.style.display='block'; // Always show back button
  deck.innerHTML='<div class="loading"><div class="loading-spinner"></div><p>Finding tracks from Spotify...</p></div>';
  deck.classList.add('active');
  queue=[];idx=liked=total=0;likedTracks=[];updateStats();
  await fetchMore();
  if(queue.length > 0) {
    renderDeck();
  } else {
    deck.innerHTML='<div class="loading"><p>No tracks found. Click "Change Genres" below to try different ones.</p></div>';
  }
}

async function fetchMore(){
  try{
    const allTracks = [];
    
    // First, let's try a very simple search that should definitely work
    const testParams = {
      q: 'track:*', // Search for any track
      type: 'track',
      limit: 50
    };
    
    const testQs = new URLSearchParams(testParams);
    console.log('Testing basic search with:', testQs.toString());
    
    const testResp = await fetch(`${API}/search?${testQs}`, {
      headers: {Authorization: `Bearer ${token}`}
    });
    
    if(!testResp.ok) {
      const errorData = await testResp.text();
      console.error('Search API error:', testResp.status, errorData);
      
      if(testResp.status === 401) {
        showErr('Session expired. Please refresh and login again.');
        sessionStorage.removeItem('tok');
        setTimeout(() => location.reload(), 2000);
        return;
      }
    } else {
      const testData = await testResp.json();
      console.log('Search API works! Found tracks:', testData.tracks?.items?.length || 0);
    }
    
    // Now try genre-based searches with simpler queries
    for(const genre of chosen) {
      // Try different search approaches
      const searches = [
        genre, // Just the genre name
        `${genre} music`, // Genre + music
        `top ${genre} hits`, // Popular tracks
        `best ${genre} songs` // Another variation
      ];
      
      for(const searchTerm of searches.slice(0, 2)) { // Try first 2 variations
        const searchParams = {
          q: searchTerm,
          type: 'track',
          limit: 20
        };
        
        const searchQs = new URLSearchParams(searchParams);
        console.log(`Searching for: "${searchTerm}"`);
        
        const searchResp = await fetch(`${API}/search?${searchQs}`, {
          headers: {Authorization: `Bearer ${token}`}
        });
        
        if(searchResp.ok) {
          const searchData = await searchResp.json();
          if(searchData.tracks && searchData.tracks.items) {
            const tracks = searchData.tracks.items;
            console.log(`Found ${tracks.length} tracks for "${searchTerm}"`);
            allTracks.push(...tracks);
          }
        }
      }
    }
    
    // If still no tracks, try some guaranteed searches
    if(allTracks.length < 10) {
      const popularSearches = [
        'top hits 2024',
        'popular songs',
        'billboard hot 100',
        'viral hits',
        'trending music'
      ];
      
      for(const search of popularSearches.slice(0, 2)) {
        const popParams = {
          q: search,
          type: 'track',
          limit: 30
        };
        
        const popQs = new URLSearchParams(popParams);
        console.log(`Fallback search: "${search}"`);
        
        const popResp = await fetch(`${API}/search?${popQs}`, {
          headers: {Authorization: `Bearer ${token}`}
        });
        
        if(popResp.ok) {
          const popData = await popResp.json();
          if(popData.tracks && popData.tracks.items) {
            console.log(`Found ${popData.tracks.items.length} tracks for "${search}"`);
            allTracks.push(...popData.tracks.items);
          }
        }
      }
    }
    
    // Remove duplicates
    const uniqueTracks = Array.from(new Map(allTracks.map(t => [t.id, t])).values());
    console.log(`Total unique tracks found: ${uniqueTracks.length}`);
    
    // Log preview URL stats
    const tracksWithPreviews = uniqueTracks.filter(t => t && t.preview_url);
    const tracksWithoutPreviews = uniqueTracks.filter(t => t && !t.preview_url);
    console.log(`Tracks with preview URLs: ${tracksWithPreviews.length}`);
    console.log(`Tracks without preview URLs: ${tracksWithoutPreviews.length}`);
    
    // Filter out already seen tracks
    const newTracks = tracksWithPreviews.filter(t => {
      return !likedTracks.find(lt => lt.id === t.id) &&
             !queue.find(q => q.id === t.id);
    });
    
    if(newTracks.length > 0) {
      queue.push(...newTracks.sort(() => Math.random() - 0.5));
      console.log(`Added ${newTracks.length} new tracks to queue. Total in queue: ${queue.length}`);
    } else if(tracksWithoutPreviews.length > 0) {
      showErr(`Found ${uniqueTracks.length} tracks but none have preview URLs. This is a Spotify API limitation.`);
    } else {
      showErr('No tracks found. Check console for details.');
    }
    
  }catch(e){
    console.error('Fetch error:', e);
    showErr(`Error: ${e.message}. Check console for details.`);
  }
}

/* ---------- RENDER & INTERACTION ---------- */
function renderDeck(){
  deck.innerHTML='';
  for(let n=0;n<Math.min(3,queue.length-idx);n++)addCard(queue[idx+n],n);
}

function addCard(t,pos){
  const c=document.createElement('div');
  c.className='card';
  c.style.zIndex=10-pos;
  c.style.transform=`scale(${1-pos*.05}) translateY(${pos*10}px)`;
  c.style.opacity = 1 - pos * 0.3;
  
  const albumImg = t.album?.images?.[0]?.url || '';
  
  c.innerHTML=`<div class="card-content">
    <div class="album-art">
      <img src="${albumImg}" alt="${t.name} - ${t.album?.name || 'Album'}"/>
      <div class="audio-player">
        <button class="play-button"><span class="play-icon">▶</span></button>
        <div class="progress-bar"><div class="progress"></div></div>
        <span class="time">0:00</span>
      </div>
    </div>
    <div class="song-info">
      <h2>${t.name}</h2>
      <p class="artist">${t.artists.map(a => a.name).join(', ')}</p>
      <p class="genre">${chosen.join(', ') || 'Discover'}</p>
      <div class="popularity">
        <span>Popularity</span>
        <div class="popularity-bar"><div class="popularity-fill" style="width:${t.popularity}%"></div></div>
        <span>${t.popularity}%</span>
      </div>
    </div>
    <div class="love-indicator">LOVE</div>
    <div class="nope-indicator">NOPE</div>
  </div>`;
  
  if(pos===0){
    setupSwipe(c,t);
    setupAudio(c,t);
  }
  deck.appendChild(c);
}

function setupAudio(card,t){
  const btn=card.querySelector('.play-button'),
        icon=btn.querySelector('.play-icon'),
        bar=card.querySelector('.progress'),
        tm=card.querySelector('.time');
  
  // Auto-play first card if enabled
  if(autoplayEnabled && card === deck.querySelector('.card')){
    setTimeout(() => btn.click(), 500);
  }
  
  btn.onclick=()=>{
    if(audio&&playing){
      audio.pause();
      playing=false;
      icon.textContent='▶';
      return;
    }
    
    if(audio)audio.pause();
    if(prog)clearInterval(prog);
    
    audio=new Audio(t.preview_url);
    audio.volume=0.5;
    
    audio.play().then(()=>{
      playing=true;
      icon.textContent='⏸';
      prog=setInterval(()=>{
        if(!audio.duration)return;
        const pct = (audio.currentTime/audio.duration)*100;
        bar.style.width=pct+'%';
        const s=Math.floor(audio.currentTime);
        tm.textContent=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
      },100);
    }).catch(e => {
      console.error('Playback error:', e);
      showErr('Cannot play preview. Track might be region-locked.');
      icon.textContent='▶';
    });
    
    audio.onended=()=>{
      playing=false;
      icon.textContent='▶';
      clearInterval(prog);
      bar.style.width='0%';
      tm.textContent='0:00';
    };
  };
}

function setupSwipe(card,track){
  let sx=0,dx=0,dy=0,sy=0,drag=false,
      love=card.querySelector('.love-indicator'),
      nope=card.querySelector('.nope-indicator');
  
  const start=e=>{
    drag=true;
    sx=(e.touches?e.touches[0].clientX:e.clientX);
    sy=(e.touches?e.touches[0].clientY:e.clientY);
    card.classList.add('dragging');
  };
  
  const move=e=>{
    if(!drag)return;
    e.preventDefault();
    dx=(e.touches?e.touches[0].clientX:e.clientX)-sx;
    dy=(e.touches?e.touches[0].clientY:e.clientY)-sy;
    
    const rotation = dx/10;
    const scale = 1 - Math.abs(dx)/1000;
    card.style.transform=`translateX(${dx}px) translateY(${dy/2}px) rotate(${rotation}deg) scale(${scale})`;
    
    const opacity = Math.min(Math.abs(dx)/100, 1);
    love.style.opacity=dx>0?opacity:0;
    nope.style.opacity=dx<0?opacity:0;
  };
  
  const end=()=>{
    if(!drag)return;
    drag=false;
    card.classList.remove('dragging');
    
    if(Math.abs(dx)>100){
      swipe(dx>0,track);
    }else{
      card.style.transform='';
      love.style.opacity=0;
      nope.style.opacity=0;
    }
  };
  
  ['mousedown','touchstart'].forEach(ev=>card.addEventListener(ev,start));
  ['mousemove','touchmove'].forEach(ev=>document.addEventListener(ev,move,{passive:false}));
  ['mouseup','mouseleave','touchend'].forEach(ev=>document.addEventListener(ev,end));
}

/* ---------- SWIPE ACTIONS ---------- */
function swipe(isLike,track){
  const card = deck.querySelector('.card');
  if(!card) return;
  
  // Stop audio if playing
  if(audio){
    audio.pause();
    playing=false;
    if(prog)clearInterval(prog);
  }
  
  card.classList.add(isLike?'swiped-right':'swiped-left');
  total++;
  
  if(isLike){
    liked++;
    likedTracks.push(track);
    updatePreferences(track);
  }
  
  updateStats();
  idx++;
  
  // Preload more tracks if running low
  if(queue.length-idx<10)fetchMore();
  
  setTimeout(()=>{
    card.remove();
    if(idx<queue.length){
      renderDeck();
    }else{
      deck.innerHTML='<div class="loading"><div class="loading-spinner"></div><p>Loading more tracks...</p></div>';
      fetchMore().then(()=>{
        if(queue.length>idx){
          renderDeck();
        }else{
          deck.innerHTML='<div class="loading"><p>No more tracks available.</p></div>';
          backBtn.style.display='block';
        }
      });
    }
  },300);
}

/* ---------- PREFERENCES LEARNING ---------- */
function updatePreferences(track){
  // Update artist preferences
  track.artists.forEach(a => {
    userPrefs.artists[a.id] = (userPrefs.artists[a.id] || 0) + 1;
  });
  
  // Show playlist button after 5 likes
  if(liked >= 5){
    playlistBtn.style.display = 'block';
  }
}

/* ---------- STATS & PLAYLIST ---------- */
function updateStats(){
  likedEl.textContent=liked;
  totalEl.textContent=total;
  
  // Show back button if no tracks
  if(total > 0 && queue.length - idx === 0){
    backBtn.style.display='block';
  }
}

async function createPlaylist(){
  if(likedTracks.length === 0){
    showErr('No tracks liked yet!');
    return;
  }
  
  playlistBtn.disabled = true;
  playlistBtn.textContent = 'Creating...';
  
  try{
    // Create playlist
    const playlistData = {
      name: `Jungl Discovery ${new Date().toLocaleDateString()}`,
      description: `${liked} tracks discovered on Jungl from genres: ${chosen.join(', ')}`,
      public: false
    };
    
    const createResp = await fetch(`${API}/users/${userId}/playlists`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(playlistData)
    });
    
    if(!createResp.ok){
      const err = await createResp.json();
      throw new Error(err.error?.message || 'Failed to create playlist');
    }
    
    const playlist = await createResp.json();
    
    // Add tracks (Spotify limits to 100 per request)
    const uris = likedTracks.map(t => t.uri);
    
    for(let i = 0; i < uris.length; i += 100){
      const batch = uris.slice(i, i + 100);
      const addResp = await fetch(`${API}/playlists/${playlist.id}/tracks`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({uris: batch})
      });
      
      if(!addResp.ok){
        console.error('Failed to add tracks batch');
      }
    }
    
    playlistBtn.textContent = '✓ Playlist Created!';
    showErr(`Success! Created "${playlist.name}" with ${likedTracks.length} tracks!`);
    
    // Open playlist in Spotify
    if(playlist.external_urls?.spotify){
      setTimeout(() => {
        window.open(playlist.external_urls.spotify, '_blank');
      }, 1500);
    }
    
    setTimeout(() => {
      playlistBtn.textContent = 'Create Another Playlist';
      playlistBtn.disabled = false;
    }, 3000);
    
  }catch(e){
    console.error('Playlist error:', e);
    showErr(`Failed to create playlist: ${e.message}`);
    playlistBtn.textContent = 'Create Playlist';
    playlistBtn.disabled = false;
  }
}

/* ---------- BUTTON ACTIONS ---------- */
document.getElementById('like').onclick=()=>{
  const card = deck.querySelector('.card');
  if(card && idx < queue.length){
    swipe(true, queue[idx]);
  }
};

document.getElementById('dislike').onclick=()=>{
  const card = deck.querySelector('.card');
  if(card && idx < queue.length){
    swipe(false, queue[idx]);
  }
};

/* ---------- KEYBOARD SHORTCUTS ---------- */
document.addEventListener('keydown', (e) => {
  if(e.key === 'ArrowLeft'){
    document.getElementById('dislike').click();
  }else if(e.key === 'ArrowRight'){
    document.getElementById('like').click();
  }else if(e.key === ' '){
    e.preventDefault();
    const playBtn = deck.querySelector('.card .play-button');
    if(playBtn) playBtn.click();
  }else if(e.key === 'a' || e.key === 'A'){
    autoplayEnabled = !autoplayEnabled;
    showErr(`Autoplay ${autoplayEnabled ? 'enabled' : 'disabled'}`);
  }
});
</script>
</body>
</html>
