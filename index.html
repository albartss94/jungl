<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Jungl - Discover New Music</title>
<style>/* ------------- (ALL YOUR ORIGINAL CSS UNCHANGED) ------------- */
*{margin:0;padding:0;box-sizing:border-box}
/* ... full CSS from your initial file ... */
</style>
</head>
<body>
<!-- ================= HEADER (unchanged markup) ================= -->
<div class="header">
    <div class="logo-section">
        <div class="logo">
            <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="junglGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#1DB954"/><stop offset="100%" style="stop-color:#1ed760"/>
                </linearGradient></defs>
                <path d="M20 5L35 15v10L20 35 5 25V15Z" fill="url(#junglGradient)"/>
                <path d="M20 12l7 5v6l-7 5-7-5v-6Z" fill="#0a0a0a"/>
                <circle cx="20" cy="20" r="3" fill="url(#junglGradient)"/>
            </svg>
        </div>
        <div>
            <div class="brand-name">jungl</div>
            <div class="tagline">Discover your sound</div>
        </div>
    </div>
    <div class="login-section" id="loginSection">
        <button class="login-button" id="headerLoginBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 3a3 3 0 1 1-3 3 3.003 3.003 0 0 1 3-3Zm0 14.2a7.193 7.193 0 0 1-6-3.22c.03-2 3.99-3.08 6-3.08s5.97 1.09 6 3.08a7.192 7.192 0 0 1-6 3.22Z"/>
            </svg>
            Connect Spotify
        </button>
    </div>
    <div class="user-info" id="userInfo">
        <span id="userName">User</span><div class="user-avatar"></div>
    </div>
</div>

<!-- ================ MAIN (all original markup) ================ -->
<div class="app-container">
    <!-- welcome block -->
    <div class="login-prompt" id="loginPrompt">
        <h2>Welcome to Jungl</h2>
        <p>Discover new music that matches your vibe. Connect your Spotify account to start swiping through fresh tracks and build your perfect playlist.</p>
        <button class="spotify-login-btn" id="mainLoginBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0Zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02Zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2Zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3Z"/>
            </svg>
            Connect with Spotify
        </button>
    </div>

    <!-- card stack / buttons / stats / demo info -->
    <!-- (identical to your original markup) -->
    <div class="card-stack" id="cardStack"><div class="loading"><div class="loading-spinner"></div><p>Loading your music...</p></div></div>
    <div class="action-buttons" id="actionButtons" style="display:none"><button class="action-button dislike-button" id="dislikeBtn">âœ•</button><button class="action-button like-button" id="likeBtn">â™¥</button></div>
    <div class="stats" id="stats" style="display:none"><span id="likedCount">0</span> songs liked â€¢ <span id="totalCount">0</span> songs heard</div>
    <div class="info-section" id="infoSection" style="display:none">
        <h3>ðŸŽµ Demo Mode</h3><p>This is currently running in demo mode with sample tracks.</p>
        <p>To connect real Spotify music, you'll need:</p>
        <div class="code-block">1. Spotify Developer Account<br>2. Client&nbsp;ID &amp; Client&nbsp;Secret<br>3. Backend server for OAuth<br>4. Deployed web app with HTTPS</div>
        <p>Get started at <strong>developer.spotify.com</strong></p>
    </div>
</div>

<!-- ================= SCRIPT (updated PKCE login) ================ -->
<script>
/* ---------- 0. CONFIG ---------- */
const SPOTIFY_CLIENT_ID = '564aa538caf242638e9f895679012e50';
const REDIRECT_URI      = 'https://albartss94.github.io/jungl/';
const SPOTIFY_AUTH_URL  = 'https://accounts.spotify.com/authorize';
const SPOTIFY_TOKEN_URL = 'https://accounts.spotify.com/api/token';
const SPOTIFY_API_BASE  = 'https://api.spotify.com/v1';
const SPOTIFY_SCOPES = [
  'user-read-private','user-read-email',
  'playlist-modify-public','playlist-modify-private',
  'user-top-read','user-library-read','offline_access'
];

/* ---------- 1. UTILITIES ---------- */
function generateRandomString(len){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const arr=crypto.getRandomValues(new Uint8Array(len));
  return arr.reduce((acc,x)=>acc+chars[x%chars.length],'');
}
async function sha256(plain){
  return crypto.subtle.digest('SHA-256', new TextEncoder().encode(plain));
}
function base64url(buf){
  return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
}

/* ---------- 2. GLOBAL APP STATE (unchanged) ---------- */
let currentSongIndex=0,likedSongs=[],currentAudio=null,isPlaying=false,
    progressInterval=null,isLoggedIn=false,accessToken=null,spotifySongs=[],
    junglPlaylistId=null,likedCount=0,totalCount=0;

/* ---------- 3. DOM REFS (unchanged) ---------- */
const cardStack=document.getElementById('cardStack');
const likeBtn=document.getElementById('likeBtn');
const dislikeBtn=document.getElementById('dislikeBtn');
const likedCountEl=document.getElementById('likedCount');
const totalCountEl=document.getElementById('totalCount');
const loginPrompt=document.getElementById('loginPrompt');
const actionButtons=document.getElementById('actionButtons');
const stats=document.getElementById('stats');
const infoSection=document.getElementById('infoSection');

/* ---------- 4. PKCE LOGIN FLOW ---------- */
async function initiateSpotifyLogin(){
  /* 4-A create verifier & challenge */
  const codeVerifier = generateRandomString(64);
  sessionStorage.setItem('code_verifier',codeVerifier);
  const codeChallenge = base64url(await sha256(codeVerifier));

  /* 4-B CSRF state */
  const state = generateRandomString(16);
  sessionStorage.setItem('spotify_oauth_state',state);

  /* 4-C build query and redirect */
  const params={
    response_type:'code',
    client_id:SPOTIFY_CLIENT_ID,
    redirect_uri:REDIRECT_URI,
    code_challenge_method:'S256',
    code_challenge:codeChallenge,
    state,
    scope:SPOTIFY_SCOPES.join(' ')
  };
  window.location.href=`${SPOTIFY_AUTH_URL}?${new URLSearchParams(params)}`;
}

/* ---------- 5. HANDLE REDIRECT ---------- */
async function handleAuthCallback(code){
  /* 5-A verify state */
  const returnedState=new URLSearchParams(location.search).get('state');
  const storedState=sessionStorage.getItem('spotify_oauth_state');
  if(!returnedState||returnedState!==storedState){
    alert('State mismatch â€“ aborting login.');
    return;
  }
  sessionStorage.removeItem('spotify_oauth_state');

  /* 5-B exchange code â†’ token */
  const codeVerifier=sessionStorage.getItem('code_verifier');
  const res=await fetch(SPOTIFY_TOKEN_URL,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({
      grant_type:'authorization_code',
      client_id:SPOTIFY_CLIENT_ID,
      code,
      redirect_uri:REDIRECT_URI,
      code_verifier:codeVerifier
    })
  });
  const data=await res.json();
  if(!data.access_token){
    console.error('Token error',data);alert('Spotify auth failed');return;
  }
  accessToken=data.access_token;
  sessionStorage.setItem('spotify_access_token',accessToken);
  sessionStorage.setItem('spotify_token_expiry',(Date.now()+data.expires_in*1000)+'');
  if(data.refresh_token){
    sessionStorage.setItem('spotify_refresh_token',data.refresh_token);
  }
  sessionStorage.removeItem('code_verifier');

  /* 5-C strip ?code= & ?state= from URL */
  history.replaceState({},document.title,REDIRECT_URI);

  /* 5-D continue app */
  await handleSuccessfulLogin();
}

/* ---------- 6. REST OF ORIGINAL JS (UNMODIFIED) ---------- */
/* - mockSongs                                              */
/* - handleSuccessfulLogin                                  */
/* - loadSpotifySongs                                       */
/* - getOrCreateJunglPlaylist / addSongToPlaylist           */
/* - UI & swipe logic, audio player, stats, etc.            */
/*   (copy them exactly as in your current file)            */

/* ---------- 7. INITIALISATION ---------- */
window.addEventListener('load',async()=>{
  document.getElementById('headerLoginBtn').onclick=initiateSpotifyLogin;
  document.getElementById('mainLoginBtn').onclick=initiateSpotifyLogin;

  const params=new URLSearchParams(location.search);
  const code=params.get('code');
  if(code){await handleAuthCallback(code);return;}

  /* silent re-login if token still valid */
  const t=sessionStorage.getItem('spotify_access_token');
  const exp=sessionStorage.getItem('spotify_token_expiry');
  if(t&&exp&&Date.now()<+exp){accessToken=t;await handleSuccessfulLogin();}
});
</script>
</body>
</html>
